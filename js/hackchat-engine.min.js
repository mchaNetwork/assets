var HackchatEngine=function(e){"use strict";var t={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function n(){}function i(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function r(e,t,n,r,c){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new i(n,r||e,c),h=s?s+t:t;return e._events[h]?e._events[h].fn?e._events[h]=[e._events[h],o]:e._events[h].push(o):(e._events[h]=o,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(s=!1)),o.prototype.eventNames=function(){var e,n,i=[];if(0===this._eventsCount)return i;for(n in e=this._events)t.call(e,n)&&i.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=s?s+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,r=n.length,c=new Array(r);i<r;i++)c[i]=n[i].fn;return c},o.prototype.listenerCount=function(e){var t=s?s+e:e,n=this._events[t];return n?n.fn?1:n.length:0},o.prototype.emit=function(e,t,n,i,r,c){var o=s?s+e:e;if(!this._events[o])return!1;var h,a,l=this._events[o],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,i),!0;case 5:return l.fn.call(l.context,t,n,i,r),!0;case 6:return l.fn.call(l.context,t,n,i,r,c),!0}for(a=1,h=new Array(u-1);a<u;a++)h[a-1]=arguments[a];l.fn.apply(l.context,h)}else{var d,p=l.length;for(a=0;a<p;a++)switch(l[a].once&&this.removeListener(e,l[a].fn,void 0,!0),u){case 1:l[a].fn.call(l[a].context);break;case 2:l[a].fn.call(l[a].context,t);break;case 3:l[a].fn.call(l[a].context,t,n);break;case 4:l[a].fn.call(l[a].context,t,n,i);break;default:if(!h)for(d=1,h=new Array(u-1);d<u;d++)h[d-1]=arguments[d];l[a].fn.apply(l[a].context,h)}}return!0},o.prototype.on=function(e,t,s){return r(this,e,t,s,!1)},o.prototype.once=function(e,t,s){return r(this,e,t,s,!0)},o.prototype.removeListener=function(e,t,n,i){var r=s?s+e:e;if(!this._events[r])return this;if(!t)return c(this,r),this;var o=this._events[r];if(o.fn)o.fn!==t||i&&!o.once||n&&o.context!==n||c(this,r);else{for(var h=0,a=[],l=o.length;h<l;h++)(o[h].fn!==t||i&&!o[h].once||n&&o[h].context!==n)&&a.push(o[h]);a.length?this._events[r]=1===a.length?a[0]:a:c(this,r)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&c(this,t)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=s,o.EventEmitter=o,e.exports=o}(t);var s=t.exports;const n={ignoredEvents:[],restTimeOffset:500,ws:{gateway:"wss://hack.chat/chat-ws"},http:{configPath:"config.json"},isBot:!0},i="Getting ready took too long. . .",r="Nickname must consist of up to 24 letters, numbers, and underscores",c="Invalid channel",o=0,h=1,a=2,l=3,u="session",d="join",p="chat",m="invite",g="changenick",w="kick",f="ban",v="muzzle",y="unmuzzle",k="enablecaptcha",b="disablecaptcha",x="lockroom",E="unlockroom",$="whisper",C="connected",P="session",O="message",S="information",j="warning",_="channelJoined",R="userJoined",I="userLeft",T="userUpdate",U="gotCaptcha",M="reconnect",Q="emote",D="invite",A="whisper",B="ready",L="disconnect",W="reconnecting",q="error",N="debug",J="session",z="chat",H="info",F="emote",G="warn",K="onlineSet",V="onlineAdd",X="onlineRemove",Y="updateUser",Z="captcha",ee="invite",te="whisper";var se={exports:{}};!function(e,t){var s=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==s)return s;throw new Error("unable to locate global object")}();e.exports=t=s.fetch,t.default=s.fetch.bind(s),t.Headers=s.Headers,t.Request=s.Request,t.Response=s.Response}(se,se.exports);var ne=se.exports;const ie=n.http;class re{constructor(e){this.packetRouter=e}static handle(e){return e}}class ce extends re{handle(e){const{client:t}=this.packetRouter;t.readyAt=new Date;const s=t.setTimeout((()=>{t.ws.connection.triggerReady()}),1);t.once("ready",(()=>{t.setMaxListeners(10),t.clearTimeout(s)}));const n=t.events.Session.handle(e);t.emit(P,n.session),t.emit(N,`[${P}]: ${e}`)}}class oe extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Chat.handle(e);t.emit(O,s.message),t.emit(N,`[${O}]: ${e}`)}}class he extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Info.handle(e);t.emit(S,s.message),t.emit(N,`[${S}]: ${e}`)}}class ae extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Emote.handle(e);t.emit(Q,s.message),t.emit(N,`[${Q}]: ${e}`)}}class le extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Invite.handle(e);t.emit(D,s.message),t.emit(N,`[${D}]: ${e}`)}}class ue extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Warning.handle(e);t.emit(j,s.warn),t.emit(N,`[${j}]: ${e}`)}}class de extends re{handle(e){const{client:t}=this.packetRouter;t.events.OnlineSet.handle(e),t.emit(_,{client:t,channel:e.channel}),t.emit(N,`[${_}]: ${e}`)}}class pe extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.UserJoin.handle(e);t.emit(R,s),t.emit(N,`[${R}]: ${e}`)}}class me extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.UserLeave.handle(e);t.emit(I,s),t.emit(N,`[${I}]: ${e}`)}}class ge extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.UpdateUser.handle(e);t.emit(T,s),t.emit(N,`[${T}]: ${e}`)}}class we extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Captcha.handle(e);t.emit(U,s),t.emit(N,`[${U}]: ${e}`)}}class fe extends re{handle(e){const{client:t}=this.packetRouter,s=t.events.Whisper.handle(e);t.emit(A,s.message),t.emit(N,`[${A}]: ${e}`)}}const ve=[J];class ye{constructor(e){this.ws=e,this.handlers={},this.queue=[],this.registerEvent(J,ce),this.registerEvent(z,oe),this.registerEvent(H,he),this.registerEvent(F,ae),this.registerEvent(ee,le),this.registerEvent(G,ue),this.registerEvent(K,de),this.registerEvent(V,pe),this.registerEvent(X,me),this.registerEvent(Y,ge),this.registerEvent(Z,we),this.registerEvent(te,fe)}get client(){return this.ws.client}registerEvent(e,t){this.handlers[e]=new t(this)}processQueue(){this.queue.forEach(((e,t)=>{this.route(this.queue[t],!0),this.queue.splice(t,1)}))}route(e,t=!1){return void 0===this.ws.ignoredEvents[e.cmd]&&(this.ws.status!==o&&-1===ve.indexOf(e.cmd)?(this.queue.push(e),!1):(!t&&this.queue.length>0&&this.processQueue(),!!this.handlers[e.cmd]&&this.handlers[e.cmd].handle(e)))}}const ke="undefined"!=typeof window?window.WebSocket:function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")};class be extends s{constructor(e,t){super(),this.controller=e,this.client=e.client,this.ws=null,this.status=a,this.packetRouter=new ye(this),this.packetQueue={queue:[],remaining:120,total:120,time:6e4,resetTimer:null},this.ignoredEvents={},this.client.options.ignoredEvents.forEach((e=>{this.ignoredEvents[e]=!0})),this.closeExpected=!1,this.sessionID="",this.client.on(P,(e=>{this.sessionID=e.sessionID})),this.connect(t)}triggerReady(){this.status!==o?(this.status=o,this.client.emit(B),this.packetRouter.processQueue()):this.debug("Attempted to trigger ready when status was ready")}debug(e){let t=e;return e instanceof Error&&(t=e.stack),this.controller.debug(`[socket handler] ${t}`)}pushPackets(){if(0!==this.packetQueue.remaining&&0!==this.packetQueue.queue.length)for(this.packetQueue.remaining===this.packetQueue.total&&(this.packetQueue.resetTimer=this.client.setTimeout((()=>{this.packetQueue.remaining=this.packetQueue.total,this.pushPackets()}),this.packetQueue.time));this.packetQueue.remaining>0;){const e=this.packetQueue.queue.shift();if(!e)return;this.wsSend(e),this.packetQueue.remaining-=1}}wsSend(e){this.ws&&this.ws.readyState===ke.OPEN?this.ws.send(JSON.stringify(e)):this.debug(`[socket handler] No connection, failed to send: ${e}`)}send(e){this.ws&&this.ws.readyState===ke.OPEN?(this.packetQueue.queue.push(e),this.pushPackets()):this.debug(`[socket handler] No connection, failed to send: ${e}`)}connect(e=this.gateway,t=0,s=!1){return t?(this.client.setTimeout((()=>{this.connect(e,0,s)}),t),!1):this.ws&&!s?(this.debug("[socket handler] Connection already exists"),!1):"string"!=typeof e?(this.debug(`[socket handler] Invalid gateway: ${e}`),!1):(this.closeExpected=!1,this.gateway=e,this.debug(`[socket handler] Connecting to ${e}`),this.ws=new ke(e),this.ws.onmessage=this.onMessage.bind(this),this.ws.onopen=this.onOpen.bind(this),this.ws.onerror=this.onError.bind(this),this.ws.onclose=this.onClose.bind(this),this.status=h,!0)}destroy(){return this.ws?(this.closeExpected=!0,this.ws.close(1e3),this.packetRouter.processQueue(),this.ws=null,this.status=l,this.packetQueue.remaining=this.packetQueue.total,!0):(this.debug("[socket handler] Cannot destroy what doesnt exist"),!1)}onMessage(e){let t;try{t=JSON.parse(e.data)}catch(e){return this.emit("debug",e),!1}return this.onPacket(t)}onPacket(e){if(!e)return this.debug("[socket handler] Server sent empty message"),!1;switch(this.client.emit("raw",e),e.cmd){case M:return this.reconnect();default:return this.packetRouter.route(e)}}onOpen(){this.debug(`[socket handler] Connected to gateway ${this.gateway}`),this.client.emit(C,this.client),this.sessionStart()}reconnect(){this.debug("[socket handler] Forcing reconnect in 5.5 seconds"),this.client.emit(W),this.connect(this.gateway,5500,!0)}onError(e){this.client.emit(q,e)}onClose(e){if(this.debug(`[socket handler] Connection lost: ${e.code}`),1e3===e.code&&this.closeExpected)return this.closeExpected=!1,this.client.emit(L,e),void this.destroy();this.closeExpected=!1,this.reconnect()}sessionStart(){return this.sessionID?this.resumeSession():this.newSession()}newSession(){this.debug("[socket handler] Identifying as a new session");const e={cmd:u,isBot:this.client.options.isBot};return this.send(e)}resumeSession(){if(!this.sessionID)return this.debug("[socket handler] Cannot resume session without session id, starting new. . ."),this.newSession();this.debug(`[socket handler] Attempting to resume session ${this.sessionID}`);const e={cmd:u,isBot:this.client.options.isBot,id:this.sessionID};return this.send(e)}}be.WebSocket=ke;class xe extends s{constructor(e){super(),this.client=e,this.connection=null}debug(e){return this.client.emit("debug",`[socket controller] ${e}`)}destroy(){return this.connection?this.connection.destroy():(this.debug("[socket controller] With strange aeons even death may die. . ."),!1)}send(e){this.connection?this.connection.send(e):this.debug("[socket controller] Cannot send: not connected")}connect(e){if(!this.connection)return this.connection=new be(this,e),!0;switch(this.connection.status){case a:break;case l:return this.connection.connect(e,5500),!0;default:return this.debug(`[socket controller] Failed to connect to ${e} due to state: ${this.connection.status}`),!1}return!1}}class Ee{constructor(e){this.client=e}static handle(e){return{data:e}}}class $e{constructor(e,t){Object.defineProperty(this,"client",{value:e}),this.setup(t)}setup(e){this.channelCount=e.chans,this.publicChannels=e.public,this.sessionID=e.sessionID,this.userCount=e.users,this.restored=e.restored}}class Ce extends Ee{handle(e){const{client:t}=this;return{session:new $e(t,e)}}}class Pe{constructor(e,t){Object.defineProperty(this,"client",{value:e}),this.setup(t)}setup(e){this.text=e.text,this.channel=e.channel}}class Oe extends Ee{handle(e){return{captchaData:new Pe(this.client,e)}}}class Se{constructor(e,t,s){Object.defineProperty(this,"client",{value:s}),this.channel=t.channel,this.user=e,t&&this.setup(t)}setup(e){this.content=e.text,this.timestamp=new Date}get createdAt(){return new Date(this.timestamp)}async reply(e){try{return new Promise((t=>{this.client.ws.send({cmd:p,channel:this.channel,text:e}),t(this)}))}catch(e){return Promise.reject(e)}}toString(){return this.content}}class je extends Ee{handle(e){const{client:t}=this,s=t.users.get(e.userid),n=new Se(s,e,t);return s.setLastMessage(n),{message:n}}}class _e{constructor(e,t){Object.defineProperty(this,"client",{value:e}),this.setup(t)}setup(e){this.text=e.text,this.channel=e.channel}}class Re extends Ee{handle(e){const{client:t}=this;return{message:new _e(t,e)}}}class Ie{constructor(e,t,s){Object.defineProperty(this,"client",{value:e}),Object.defineProperty(this,"user",{value:t}),this.setup(s)}setup(e){this.content=e.text,this.channel=e.channel}}class Te extends Ee{handle(e){const{client:t}=this,s=t.users.find((t=>t.userid===e.userid));return{message:new Ie(t,s,e)}}}class Ue{constructor(e,t){Object.defineProperty(this,"client",{value:e}),this.setup(t)}setup(e){this.from=this.client.users.find((t=>t.userid===e.from)),this.fromMe=!1,e.from===this.client.myUser.userid&&(this.fromMe=!0),this.to=this.client.users.find((t=>t.userid===e.to)),this.targetChannel=e.inviteChannel,this.channel=e.channel}}class Me extends Ee{handle(e){const{client:t}=this;return{message:new Ue(t,e)}}}class Qe{constructor(e,t){Object.defineProperty(this,"client",{value:e}),t&&this.setup(t)}setup(e){this.userid=e.userid||-1,this.userchannel=e.channel||"unknown",this.username=e.nick||"anonymous",this.usertrip=e.trip||"",this.userhash=e.hash||"",this.userlevel=e.uType||"user",this.online=!0,this.bot=e.isBot||!1,this.lastMessage={},this.joined=new Date,this.blocked=!1,this.mine=e.isme||!1,this.nickColor=e.color||!1,this.permissionLevel=e.level||!1}get id(){return this.userid}get channel(){return this.userchannel}get name(){return this.username}get trip(){return this.usertrip}get hash(){return this.userHash}get level(){return this.userlevel}get isOnline(){return this.online}get isBot(){return this.bot}get message(){return this.lastMessage}get dateJoined(){return this.joined}get isBlocked(){return this.blocked}get tag(){return`@${this.username}${null!==this.usertrip?`#${this.usertrip}`:""}`}get isMine(){return this.mine}get color(){return this.nickColor}get perms(){return this.permissionLevel}updateUser(e){this.username=e.nick,this.userlevel=e.uType,this.bot=e.isBot,this.nickColor=e.color,this.permissionLevel=e.level}toggleOnline(e){return this.online=!this.online,this.online}setLastMessage(e){return this.lastMessage=e,this.lastMessage}toggleBlock(){return this.blocked=!this.blocked,this.blocked}sendMessage(e){try{return new Promise((t=>{this.client.ws.send({cmd:p,channel:this.channel,text:e}),t(this)}))}catch(e){return Promise.reject(e)}}sendWhisper(e){try{return new Promise((t=>{this.client.ws.send({cmd:$,channel:this.channel,userid:this.userid,text:e}),t(this)}))}catch(e){return Promise.reject(e)}}sendInvite(e,t=""){let s=t;return""===s&&(s=Math.random().toString(36).substring(2,15)),this.client.ws.send({cmd:m,userid:this.userid,channel:e,to:s})}kick(e,t=""){let s=t;""===s&&(s=Math.random().toString(36).substring(2,15)),this.client.ws.send({cmd:w,userid:this.userid,channel:e,to:s})}ban(e){this.client.ws.send({cmd:f,userid:this.userid,channel:e})}mute(e){this.client.ws.send({cmd:v,userid:this.userid,channel:e})}unmute(e){this.client.ws.send({cmd:y,hash:this.userhash,channel:e})}toString(){return`@${this.username}`}}class De extends Qe{setup(e,t){super.setup(e,t)}blockUser(e){const t=this.client.users.get(e);t&&!t.isBlocked&&t.toggleBlock()}changeUsername(e){const t={cmd:g,nick:e};this.client.ws.send(t)}}class Ae extends Ee{handle(e){const{client:t}=this;e.users.map((e=>(e.isme&&(t.myUser||(t.myUser=new De(t,e))),t.users.set(e.userid,new Qe(t,e)))))}}class Be extends Ee{handle(e){const{client:t}=this,s=t.users.get(e.userid);if(s)return s.toggleOnline(e.channel),s;const n=new Qe(t,e);return t.users.set(e.userid,n),n}}class Le extends Ee{handle(e){const{client:t}=this,s=t.users.get(e.userid);return s.toggleOnline(e.channel),s}}class We extends Ee{handle(e){const{client:t}=this,s=t.users.get(e.userid);return s.updateUser(e),s}}class qe{constructor(e,t){Object.defineProperty(this,"client",{value:e}),this.setup(t)}setup(e){this.id=e.id||0,this.text=e.text,this.channel=e.channel}}class Ne extends Ee{handle(e){const{client:t}=this;return{warn:new qe(t,e)}}}class Je{constructor(e,t){Object.defineProperty(this,"client",{value:e}),t&&this.setup(t)}setup(e){this.from=this.client.users.find((t=>t.userid===e.from)),this.fromMe=!1,e.from===this.client.myUser.userid&&(this.fromMe=!0),this.to=this.client.users.find((t=>t.userid===e.to)),this.content=e.text,this.timestamp=new Date}get createdAt(){return new Date(this.timestamp)}reply(e){return new Promise((t=>{this.client.ws.send({cmd:$,channel:this.channel,text:e}),t(this)})).catch((e=>Promise.reject(e)))}toString(){return this.content}}class ze extends Ee{handle(e){const{client:t}=this;return{message:new Je(t,e)}}}class He{constructor(e){this.client=e,this.Session=new Ce(this.client),this.Captcha=new Oe(this.client),this.Chat=new je(this.client),this.Info=new Re(this.client),this.Emote=new Te(this.client),this.Invite=new Me(this.client),this.OnlineSet=new Ae(this.client),this.UserJoin=new Be(this.client),this.UserLeave=new Le(this.client),this.UpdateUser=new We(this.client),this.Warning=new Ne(this.client),this.Whisper=new ze(this.client)}}class Fe extends Map{find(e){for(const[t,s]of this)if(e(s,t,this))return s;return null}findKey(e){for(const[t,s]of this)if(e(s,t,this))return t;return null}filter(e){const t=new Fe;for(const[s,n]of this)e(n,s,this)&&t.set(s,n);return t}some(e){for(const[t,s]of this)if(e(s,t,this))return!0;return!1}every(e){for(const[t,s]of this)if(!e(s,t,this))return!1;return!0}}const Ge=new class{async fetchWebsocketConfig(){const e=ie.configPath;try{const t=await ne(e);return await t.json()}catch(e){throw new Error(e)}}};return e.Client=class extends s{constructor(e={}){super(),this.options={...n,...e},this.ws=new xe(this),this.events=new He(this),this.readyAt=null,this.myUser=null,this.users=new Fe,this.channels=new Fe,this.timeouts=new Set,this.intervals=new Set,this.isBrowser="undefined"!=typeof window,this.connectToWebSocket().then((()=>{this.emit(N,"[client] Client ready")})).catch((e=>{console.error(e)}))}get status(){return this.ws.connection.status}get uptime(){return this.readyAt?Date.now()-this.readyAt:null}get readyTimestamp(){return this.readyAt?this.readyAt.getTime():null}get browser(){return this.isBrowser}join(e=!1,t="",s=!1){try{if(!e||"string"!=typeof e)throw new Error(r);if(!s||"string"!=typeof s)throw new Error(c);this.channel=s,this.ws.send({cmd:d,nick:e,pass:t,channel:s})}catch(e){this.destroy(),this.emit(q,`[client] Error joining channel: ${e}`)}}async connectToWebSocket(){try{return new Promise((async(e,t)=>{this.emit(N,"[client] Initiating connection. . .");const s=this.setTimeout((()=>t(new Error(i))),3e5);let{gateway:n}=this.options.ws;if(this.browser){this.emit(N,"[client] Fetching ws config");n=(await Ge.fetchWebsocketConfig()).gateway}this.emit(N,`[client] Using gateway ${n}`),this.ws.connect(n),this.ws.connection.once("error",t),this.once(B,(()=>{this.clearTimeout(s),e()}))}))}catch(e){return this.destroy(),Promise.reject(e)}}destroy(){for(const e of this.timeouts)clearTimeout(e);for(const e of this.intervals)clearInterval(e);return this.timeouts.clear(),this.intervals.clear(),Promise.resolve()}setTimeout(e,t,...s){const n=setTimeout((()=>{e(...s),this.timeouts.delete(n)}),t);return this.timeouts.add(n),n}clearTimeout(e){clearTimeout(e),this.timeouts.delete(e)}setInterval(e,t,...s){const n=setInterval(e,t,...s);return this.intervals.add(n),n}clearInterval(e){clearInterval(e),this.intervals.delete(e)}say(e,t){this.ws.send({cmd:p,channel:e,text:t})}enableCaptcha(e){this.ws.send({cmd:k,channel:e})}disableCaptcha(e){this.ws.send({cmd:b,channel:e})}lockChannel(e){this.ws.send({cmd:x,channel:e})}unlockChannel(e){this.ws.send({cmd:E,channel:e})}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
